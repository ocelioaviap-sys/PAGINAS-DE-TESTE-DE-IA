<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rastreador: Caminhada, Corrida e Bike</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>
  <style>
    :root{
      --bg:#0b1020; --card:#111833; --muted:#A3B1D1; --brand:#4F8EF7; --ok:#19c37d; --danger:#ff6464;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:#eaf0ff}
    header{padding:16px 16px 8px; display:flex; gap:12px; align-items:center; justify-content:space-between}
    h1{font-size:18px;margin:0}
    .wrap{padding:8px 16px 16px}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .controls{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding:12px}
    .controls .full{grid-column:1/-1}
    label{font-size:12px; opacity:.9}
    select, button{width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#0e1530; color:#eaf0ff}
    button{cursor:pointer; font-weight:600}
    button.primary{background:linear-gradient(180deg, #5ea1ff, #3b7af7); border:none}
    button.secondary{background:#15224b}
    button.warn{background:#3a1220; border-color:#6b1d32}
    button:disabled{opacity:.5; cursor:not-allowed}
    #map{height:44vh; min-height:280px; border-radius:16px}
    .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; padding:12px}
    .stat{background:#0e1530; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px}
    .stat .v{font-size:18px; font-weight:700}
    .muted{color:var(--muted)}
    .sessions{padding:12px}
    .session{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px; border-top:1px solid rgba(255,255,255,.06)}
    .session small{color:var(--muted)}
    .pill{padding:4px 8px; border-radius:999px; background:#0e1530; border:1px solid rgba(255,255,255,.08); font-size:12px}
    footer{padding:10px; text-align:center; color:var(--muted); font-size:12px}
    .note{padding:8px 12px; font-size:12px; color:#cdd9ff}
  </style>
</head>
<body>
  <header>
    <h1>Rastreador de Atividades</h1>
    <span class="pill" id="gpsStatus">GPS: aguardando…</span>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="controls">
        <div>
          <label for="mode">Atividade</label>
          <select id="mode">
            <option value="walk">Caminhada</option>
            <option value="run">Corrida</option>
            <option value="bike">Ciclismo</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="startBtn" class="primary">Iniciar</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="pauseBtn" class="secondary" disabled>Pausar</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="stopBtn" class="warn" disabled>Encerrar/Salvar</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="resetBtn" class="secondary" disabled>Limpar</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="exportJsonBtn" class="secondary full" disabled>Exportar JSON</button>
        </div>
        <div class="full">
          <button id="exportGpxBtn" class="secondary full" disabled>Exportar GPX</button>
        </div>
      </div>

      <div id="map"></div>

      <div class="stats">
        <div class="stat"><div class="muted">Tempo</div><div class="v" id="time">00:00:00</div></div>
        <div class="stat"><div class="muted">Distância</div><div class="v" id="distance">0,00 km</div></div>
        <div class="stat"><div class="muted">Velocidade Média</div><div class="v" id="speed">0,0 km/h</div></div>
        <div class="stat"><div class="muted">Ritmo (min/km)</div><div class="v" id="pace">-</div></div>
      </div>
    </div>

    <div class="note">Dica: para o GPS funcionar, abra esta página via <b>HTTPS</b> (ou “Adicionar à Tela inicial” no Chrome Android). Autorize o acesso à localização com alta precisão.</div>

    <div class="card sessions">
      <h3 style="margin:8px 0 0 0; font-size:16px;">Sessões salvas</h3>
      <div id="sessionsList"></div>
    </div>
  </div>

  <footer>OpenStreetMap • Leaflet | Uso pessoal</footer>

  <script>
    // --- Estado global ---
    let map, polyline, startMarker, endMarker;
    let watchId = null;
    let path = []; // {lat,lng,t}
    let distanceKm = 0;
    let running = false;
    let paused = false;
    let startTime = null;
    let pausedStart = null;
    let pausedAccumMs = 0;
    let timer = null;

    const els = {
      time: document.getElementById('time'),
      distance: document.getElementById('distance'),
      speed: document.getElementById('speed'),
      pace: document.getElementById('pace'),
      gps: document.getElementById('gpsStatus'),
      sessions: document.getElementById('sessionsList'),
      startBtn: document.getElementById('startBtn'),
      pauseBtn: document.getElementById('pauseBtn'),
      stopBtn: document.getElementById('stopBtn'),
      resetBtn: document.getElementById('resetBtn'),
      exportJsonBtn: document.getElementById('exportJsonBtn'),
      exportGpxBtn: document.getElementById('exportGpxBtn'),
      mode: document.getElementById('mode')
    };

    function initMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      polyline = L.polyline([], {weight:6, opacity:0.9}).addTo(map);
      // Tentar obter posição inicial
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          const {latitude:lat, longitude:lng} = p.coords;
          map.setView([lat,lng], 16);
        }, ()=> map.setView([0,0], 2), {enableHighAccuracy:true, timeout:8000});
      } else {
        map.setView([0,0], 2);
      }
    }

    function fmtTime(ms){
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    function fmtKm(km){ return km.toFixed(2).replace('.', ',') + ' km'; }
    function fmtKmh(kmh){ return kmh.toFixed(1).replace('.', ',') + ' km/h'; }
    function fmtPace(minPerKm){
      if(!isFinite(minPerKm) || minPerKm<=0) return '-';
      const m = Math.floor(minPerKm);
      const s = Math.round((minPerKm - m)*60);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')} min/km`;
    }

    function haversine(lat1,lng1,lat2,lng2){
      const R = 6371; // km
      const toRad = x=> x*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLng = toRad(lng2-lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c; // km
    }

    function updateStats(){
      const now = Date.now();
      const elapsedMs = running ? (now - startTime - pausedAccumMs) : (path[0]? (path[path.length-1].t - startTime - pausedAccumMs) : 0);
      els.time.textContent = fmtTime(Math.max(0, elapsedMs));
      els.distance.textContent = fmtKm(distanceKm);
      const h = elapsedMs/3600000;
      const kmh = distanceKm>0 && h>0 ? distanceKm/h : 0;
      els.speed.textContent = fmtKmh(kmh);

      const minPerKm = distanceKm>0 ? (elapsedMs/60000)/distanceKm : Infinity;
      els.pace.textContent = fmtPace(minPerKm);
    }

    function tickTimer(){
      if(timer) clearInterval(timer);
      timer = setInterval(updateStats, 1000);
    }

    function onPosition(p){
      const acc = p.coords.accuracy || 9999;
      els.gps.textContent = `GPS: ${acc.toFixed(0)} m`;
      if(acc > 60) return; // descartar leituras imprecisas
      const lat = p.coords.latitude; const lng = p.coords.longitude; const t = p.timestamp || Date.now();

      if(path.length===0){
        startMarker && map.removeLayer(startMarker);
        startMarker = L.marker([lat,lng]).addTo(map).bindPopup('Início');
        map.setView([lat,lng], 17);
        path.push({lat,lng,t});
        polyline.setLatLngs([[lat,lng]]);
        return;
      }

      const last = path[path.length-1];
      const segKm = haversine(last.lat,last.lng,lat,lng);
      if(segKm <= 0 || segKm > 0.3) return; // descartar saltos >300m
      distanceKm += segKm;
      path.push({lat,lng,t});
      polyline.addLatLng([lat,lng]);
    }

    function start(){
      if(running) return;
      path = []; distanceKm = 0; paused = false; pausedAccumMs = 0; startTime = Date.now();
      if(endMarker){ map.removeLayer(endMarker); endMarker=null; }
      polyline.setLatLngs([]);
      els.startBtn.disabled = true;
      els.pauseBtn.disabled = false;
      els.stopBtn.disabled = false;
      els.resetBtn.disabled = false;
      els.exportJsonBtn.disabled = true;
      els.exportGpxBtn.disabled = true;
      running = true; tickTimer(); updateStats();

      if(!navigator.geolocation){
        alert('Geolocalização não suportada neste dispositivo/navegador.');
        return;
      }
      watchId = navigator.geolocation.watchPosition(onPosition, err=>{
        console.warn(err);
        els.gps.textContent = 'GPS: erro';
      }, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
    }

    function pauseResume(){
      if(!running) return;
      if(!paused){
        paused = true; pausedStart = Date.now();
        els.pauseBtn.textContent = 'Retomar';
        if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      } else {
        paused = false; pausedAccumMs += (Date.now()-pausedStart);
        els.pauseBtn.textContent = 'Pausar';
        watchId = navigator.geolocation.watchPosition(onPosition, ()=>{}, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
      }
    }

    function stop(){
      if(!running) return;
      running = false;
      if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      clearInterval(timer); timer=null; updateStats();

      if(path.length){
        const last = path[path.length-1];
        endMarker && map.removeLayer(endMarker);
        endMarker = L.marker([last.lat,last.lng]).addTo(map).bindPopup('Fim');
      }

      // Salvar sessão
      const data = {
        id: 'S'+Date.now(),
        date: new Date().toISOString(),
        mode: els.mode.value,
        distanceKm: Number(distanceKm.toFixed(3)),
        durationMs: (path.length? (path[path.length-1].t - startTime - pausedAccumMs) : 0),
        path
      };
      const list = JSON.parse(localStorage.getItem('sessions')||'[]');
      list.unshift(data);
      localStorage.setItem('sessions', JSON.stringify(list));
      renderSessions();

      els.startBtn.disabled = false;
      els.pauseBtn.disabled = true; els.pauseBtn.textContent = 'Pausar';
      els.stopBtn.disabled = true;
      els.exportJsonBtn.disabled = false;
      els.exportGpxBtn.disabled = false;
    }

    function reset(){
      if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      running=false; paused=false; path=[]; distanceKm=0; pausedAccumMs=0; startTime=null; clearInterval(timer); timer=null;
      polyline.setLatLngs([]);
      if(startMarker){ map.removeLayer(startMarker); startMarker=null; }
      if(endMarker){ map.removeLayer(endMarker); endMarker=null; }
      els.startBtn.disabled = false;
      els.pauseBtn.disabled = true; els.pauseBtn.textContent = 'Pausar';
      els.stopBtn.disabled = true;
      els.resetBtn.disabled = true;
      els.exportJsonBtn.disabled = true;
      els.exportGpxBtn.disabled = true;
      els.gps.textContent = 'GPS: aguardando…';
      updateStats();
    }

    function exportJSON(){
      const list = JSON.parse(localStorage.getItem('sessions')||'[]');
      if(!list.length){ alert('Não há sessão finalizada para exportar.'); return; }
      const latest = list[0];
      const blob = new Blob([JSON.stringify(latest,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${latest.mode}-${new Date(latest.date).toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Gera GPX simples a partir de uma sessão
    function exportGPX(){
      const list = JSON.parse(localStorage.getItem('sessions')||'[]');
      if(!list.length){ alert('Não há sessão finalizada para exportar.'); return; }
      const s = list[0];
      const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="RastreadorHTML" xmlns="http://www.topografix.com/GPX/1/1">\n  <metadata>\n    <time>${s.date}</time>\n  </metadata>\n  <trk>\n    <name>${s.mode} - ${s.date}</name>\n    <trkseg>\n`;
      const gpxPoints = s.path.map(p=>`      <trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.t).toISOString()}</time></trkpt>`).join('\n') + '\n';
      const gpxFooter = `    </trkseg>\n  </trk>\n</gpx>`;
      const gpx = gpxHeader + gpxPoints + gpxFooter;
      const blob = new Blob([gpx], {type:'application/gpx+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${s.mode}-${new Date(s.date).toISOString().slice(0,19).replace(/[:T]/g,'-')}.gpx`;
      a.click(); URL.revokeObjectURL(url);
    }

    function renderSessions(){
      const list = JSON.parse(localStorage.getItem('sessions')||'[]');
      els.sessions.innerHTML = '';
      if(!list.length){ els.sessions.innerHTML = '<div class="muted">Nenhuma sessão salva ainda.</div>'; return; }
      list.slice(0,20).forEach(s=>{
        const d = new Date(s.date);
        const row = document.createElement('div'); row.className='session';
        row.innerHTML = `\n          <div>\n            <div><strong>${labelMode(s.mode)}</strong> • ${d.toLocaleDateString()} ${d.toLocaleTimeString()}</div>\n            <small>${s.distanceKm.toFixed(2)} km • ${fmtTime(s.durationMs)}</small>\n          </div>\n          <div style="display:flex; gap:6px;">\n            <button class="secondary" data-act="view" data-id="${s.id}">Ver</button>\n            <button class="secondary" data-act="dl" data-id="${s.id}">Baixar JSON</button>\n            <button class="secondary" data-act="gpx" data-id="${s.id}">Baixar GPX</button>\n            <button class="warn" data-act="del" data-id="${s.id}">Excluir</button>\n          </div>`;
        els.sessions.appendChild(row);
      });
      els.sessions.querySelectorAll('button').forEach(b=> b.addEventListener('click', onSessionAction));
    }

    function onSessionAction(e){
      const id = e.currentTarget.getAttribute('data-id');
      const act = e.currentTarget.getAttribute('data-act');
      const list = JSON.parse(localStorage.getItem('sessions')||'[]');
      const s = list.find(x=>x.id===id);
      if(!s) return;
      if(act==='view'){
        if(s.path && s.path.length){
          polyline.setLatLngs(s.path.map(p=>[p.lat,p.lng]));
          map.fitBounds(polyline.getBounds(), {padding:[20,20]});
          if(startMarker){ map.removeLayer(startMarker); startMarker=null; }
          if(endMarker){ map.removeLayer(endMarker); endMarker=null; }
          startMarker = L.marker([s.path[0].lat,s.path[0].lng]).addTo(map).bindPopup('Início');
          endMarker = L.marker([s.path[s.path.length-1].lat,s.path[s.path.length-1].lng]).addTo(map).bindPopup('Fim');
        }
      }
      if(act==='dl'){
        const blob = new Blob([JSON.stringify(s,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${s.mode}-${new Date(s.date).toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      if(act==='gpx'){
        // gerar GPX para sessão selecionada
        const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="RastreadorHTML" xmlns="http://www.topografix.com/GPX/1/1">\n  <metadata>\n    <time>${s.date}</time>\n  </metadata>\n  <trk>\n    <name>${s.mode} - ${s.date}</name>\n    <trkseg>\n`;
        const gpxPoints = s.path.map(p=>`      <trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.t).toISOString()}</time></trkpt>`).join('\n') + '\n';
        const gpxFooter = `    </trkseg>\n  </trk>\n</gpx>`;
        const gpx = gpxHeader + gpxPoints + gpxFooter;
        const blob = new Blob([gpx], {type:'application/gpx+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${s.mode}-${new Date(s.date).toISOString().slice(0,19).replace(/[:T]/g,'-')}.gpx`;
        a.click(); URL.revokeObjectURL(url);
      }
      if(act==='del'){
        const updated = list.filter(x=>x.id!==id);
        localStorage.setItem('sessions', JSON.stringify(updated));
        renderSessions();
      }
    }

    function labelMode(v){
      return v==='run'?'Corrida': v==='bike'?'Ciclismo':'Caminhada';
    }

    // --- Eventos UI ---
    window.addEventListener('load', ()=>{
      initMap(); renderSessions(); updateStats();
      els.startBtn.addEventListener('click', start);
      els.pauseBtn.addEventListener('click', pauseResume);
      els.stopBtn.addEventListener('click', stop);
      els.resetBtn.addEventListener('click', reset);
      els.exportJsonBtn.addEventListener('click', exportJSON);
      els.exportGpxBtn.addEventListener('click', exportGPX);
    });
  </script>
</body>
</html>
